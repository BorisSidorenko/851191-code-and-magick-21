(()=>{"use strict";window.GameConstants={Fireball:{size:fireballSize||24,speed:getFireballSpeed||function(e){return e?2:5}},Wizard:{speed:wizardSpeed||2,width:wizardWidth||61,getHeight:getWizardHeight||function(e){return 1.377*e},getX:getWizardX||function(e){return e/3},getY:getWizardY||function(e){return e-100}}},window.Game=function(){var e=300,t=700,i=["Кекс","Катя","Игорь"],n={},s="-reversed";n[0]={width:61,height:84,url:"img/wizard.gif"},n[0+s]={width:61,height:84,url:"img/wizard-reversed.gif"},n[1]={width:24,height:24,url:"img/fireball.gif"};var r={0:function(i,n,s){n.keysPressed.UP&&i.y>0&&(i.direction=-9&i.direction,i.direction=4|i.direction,i.y-=i.speed*s*2),n.keysPressed.UP||i.y<e-i.height&&(i.direction=-5&i.direction,i.direction=8|i.direction,i.y+=i.speed*s/3),n.keysPressed.LEFT&&(i.direction=-3&i.direction,i.direction=1|i.direction,i.x-=i.speed*s),n.keysPressed.RIGHT&&(i.direction=-2&i.direction,i.direction=2|i.direction,i.x+=i.speed*s),i.y<0&&(i.y=0),i.y>e-i.height&&(i.y=e-i.height),i.x<0&&(i.x=0),i.x>t-i.width&&(i.x=t-i.width)},1:function(e,i,n){1&e.direction&&(e.x-=e.speed*n),2&e.direction&&(e.x+=e.speed*n),(e.x<0||e.x>t)&&(e.state=1)}},a={CONTINUE:0,WIN:1,FAIL:2,PAUSE:3,INTRO:4},o={0:function(e){return e.garbage.filter((function(e){return 1===e.type})).filter((function(e){return e.x<10&&e.y>240}))[0]?a.WIN:a.CONTINUE}},d={0:function(i){return i.objects.push({direction:2,height:window.GameConstants.Wizard.getHeight(window.GameConstants.Wizard.width),speed:window.GameConstants.Wizard.speed,sprite:n[0],state:0,type:0,width:window.GameConstants.Wizard.width,x:window.GameConstants.Wizard.getX(t),y:window.GameConstants.Wizard.getY(e)}),i}},l=function(e){this.container=e,this.canvas=document.createElement("canvas"),this.canvas.width=e.clientWidth,this.canvas.height=e.clientHeight,this.container.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this._onKeyDown=this._onKeyDown.bind(this),this._onKeyUp=this._onKeyUp.bind(this),this._pauseListener=this._pauseListener.bind(this),this.setDeactivated(!1)};l.prototype={level:0,setDeactivated:function(e){this._deactivated!==e&&(this._deactivated=e,e?this._removeGameListeners():this._initializeGameListeners())},getInitialState:function(){return{currentStatus:a.CONTINUE,garbage:[],lastUpdated:null,keysPressed:{ESC:!1,LEFT:!1,RIGHT:!1,SPACE:!1,UP:!1},levelStartTime:null,objects:[],startTime:null}},initializeLevelAndStart:function(e){(e=void 0===e||e)||!this.state?(this._imagesArePreloaded=void 0,this.state=this.getInitialState(),this.state=d[this.level](this.state)):this.state.currentStatus=a.CONTINUE,this.state.levelStartTime=Date.now(),this.state.startTime||(this.state.startTime=this.state.levelStartTime),this._preloadImagesForLevel(function(){this.render(),this._initializeGameListeners(),this.update()}.bind(this))},pauseLevel:function(e){e&&(this.state.currentStatus=e),this.state.keysPressed.ESC=!1,this.state.lastUpdated=null,this._removeGameListeners(),window.addEventListener("keydown",this._pauseListener),this._drawPauseScreen()},_pauseListener:function(e){if(32===e.keyCode&&!this._deactivated){e.preventDefault();var t=this.state.currentStatus===a.WIN||this.state.currentStatus===a.FAIL;this.initializeLevelAndStart(t),window.removeEventListener("keydown",this._pauseListener)}},_drawPauseScreen:function(){var e;switch(this.state.currentStatus){case a.WIN:if(window.renderStatistics){var t=this._generateStatistics(new Date-this.state.startTime),i=this._shuffleArray(Object.keys(t));return void window.renderStatistics(this.ctx,i,i.map((function(e){return t[e]})))}e="Вы победили Газебо!\nУра!";break;case a.FAIL:e="Вы проиграли!";break;case a.PAUSE:e="Игра на паузе!\nНажмите Пробел, чтобы продолжить";break;case a.INTRO:e="Добро пожаловать!\nНажмите Пробел для начала игры"}this._drawMessage(e)},_generateStatistics:function(e){for(var t={Вы:e},n=0;n<i.length;n++){var s=e+(3e3*Math.random()-1500);s<1e3&&(s=1e3),t[i[n]]=s}return t},_shuffleArray:function(e){for(var t=e.length-1;t>0;t--){var i=Math.floor(Math.random()*(t+1)),n=e[t];e[t]=e[i],e[i]=n}return e},_drawMessage:function(e){var t=this.ctx,i=function(e,i,n,s){t.beginPath(),t.moveTo(e,i),t.lineTo(e+10,i+s/2),t.lineTo(e,i+s),t.lineTo(e+n/2,i+s-10),t.lineTo(e+n,i+s),t.lineTo(e+n-10,i+s/2),t.lineTo(e+n,i),t.lineTo(e+n/2,i+10),t.lineTo(e,i),t.stroke(),t.closePath(),t.fill()};t.fillStyle="rgba(0, 0, 0, 0.7)",i(190,40,320,100),t.fillStyle="rgba(256, 256, 256, 1.0)",i(180,30,320,100),t.fillStyle="#000",t.font="16px PT Mono",e.split("\n").forEach((function(e,i){t.fillText(e,200,80+20*i)}))},_preloadImagesForLevel:function(e){if(void 0===this._imagesArePreloaded&&(this._imagesArePreloaded=[]),this._imagesArePreloaded[this.level])e();else for(var t=Object.keys(n),i=t.length,s=this,r=function(t){var n=new Image(t.width,t.height);n.onload=function(){t.image=n,0==--i&&(s._imagesArePreloaded[s.level]=!0,e())},n.src=t.url},a=0;a<t.length;a++)r(n[t[a]])},updateObjects:function(e){var t=this.state.objects.filter((function(e){return 0===e.type}))[0];this.state.keysPressed.SHIFT&&(this.state.objects.push({direction:t.direction,height:window.GameConstants.Fireball.size,speed:window.GameConstants.Fireball.speed(!!(1&t.direction)),sprite:n[1],type:1,width:window.GameConstants.Fireball.size,x:2&t.direction?t.x+t.width:t.x-window.GameConstants.Fireball.size,y:t.y+t.height/2}),this.state.keysPressed.SHIFT=!1),this.state.garbage=[];var i=this.state.objects.filter((function(t){return r[t.type](t,this.state,e),1!==t.state||(this.state.garbage.push(t),!1)}),this);this.state.objects=i},checkStatus:function(){if(this.state.currentStatus===a.CONTINUE){this.commonRules||(this.commonRules=[function(e){return 1===e.objects.filter((function(e){return 0===e.type}))[0].state?a.FAIL:a.CONTINUE},function(e){return e.keysPressed.ESC?a.PAUSE:a.CONTINUE},function(e){return Date.now()-e.startTime>18e4?a.FAIL:a.CONTINUE}]);for(var e=this.commonRules.concat(o[this.level]),t=a.CONTINUE;t===a.CONTINUE&&e.length;)t=e.shift()(this.state);this.state.currentStatus=t}},setGameStatus:function(e){this.state.currentStatus!==e&&(this.state.currentStatus=e)},render:function(){this.ctx.clearRect(0,0,t,e),this.state.objects.forEach((function(e){if(e.sprite){var t=1&e.direction,i=n[e.type+(t?s:"")]||n[e.type];this.ctx.drawImage(i.image,e.x,e.y,e.width,e.height)}}),this)},update:function(){this.state.lastUpdated||(this.state.lastUpdated=Date.now());var e=(Date.now()-this.state.lastUpdated)/10;switch(this.updateObjects(e),this.checkStatus(),this.state.currentStatus){case a.CONTINUE:this.state.lastUpdated=Date.now(),this.render(),requestAnimationFrame(function(){this.update()}.bind(this));break;case a.WIN:case a.FAIL:case a.PAUSE:case a.INTRO:this.pauseLevel()}},_onKeyDown:function(e){switch(e.keyCode){case 37:this.state.keysPressed.LEFT=!0;break;case 39:this.state.keysPressed.RIGHT=!0;break;case 38:this.state.keysPressed.UP=!0;break;case 27:this.state.keysPressed.ESC=!0}e.shiftKey&&(this.state.keysPressed.SHIFT=!0)},_onKeyUp:function(e){switch(e.keyCode){case 37:this.state.keysPressed.LEFT=!1;break;case 39:this.state.keysPressed.RIGHT=!1;break;case 38:this.state.keysPressed.UP=!1;break;case 27:this.state.keysPressed.ESC=!1}e.shiftKey&&(this.state.keysPressed.SHIFT=!1)},_initializeGameListeners:function(){window.addEventListener("keydown",this._onKeyDown),window.addEventListener("keyup",this._onKeyUp)},_removeGameListeners:function(){window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp)}},l.Verdict=a;var c=new l(document.querySelector(".demo"));return window.restartGame=function(e,t){n[0].url=e,n[0+s].url=t,c.initializeLevelAndStart(),c.setGameStatus(a.INTRO)},window.restartGame("img/wizard.gif","img/wizard-reversed.gif"),c}(),window.util={isEscEvent:(e,t)=>{"Escape"===e.key&&t()},isEnterEvent:(e,t)=>{"Enter"===e.key&&t()},getRandomNumberMaxToMin:(e,t=0)=>Math.floor(Math.random()*(e-t+1)+t),createErrorMessage:e=>{var t=document.createElement("div");t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.zIndex=1,t.style.backgroundColor="black",t.style.textAlign="center",t.style.fontSize="15px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}},(()=>{const e=(e,t,i)=>()=>{200===e.status?t(e.response):i(`Статус ответа: ${e.status} ${e.statusText}`)};window.backend={load:(t,i)=>{const n=new XMLHttpRequest;n.responseType="json",n.timeout=1e4,n.addEventListener("load",e(n,t,i)),n.addEventListener("error",(e=>()=>e("Произошла ошибка соединения"))(i)),n.addEventListener("timeout",((e,t)=>()=>t(`Запрос не успел выполниться за ${e.timeout}мс`))(n,i)),n.open("GET","https://21.javascript.pages.academy/code-and-magick/data"),n.send()},save:(t,i,n)=>{const s=new XMLHttpRequest;s.responseType="json",s.timeout=1e4,s.addEventListener("load",e(s,i,n)),s.open("POST","https://21.javascript.pages.academy/code-and-magick"),s.send(t)}}})(),(()=>{const e=document.querySelector(".setup-wizard-form"),t=document.querySelector(".setup"),i=document.querySelector(".setup-open"),n=t.querySelector(".setup-close"),s=t.querySelector(".setup-user-name"),r=getComputedStyle(t).top,a=getComputedStyle(t).left,o=e=>{document.activeElement!==s&&window.util.isEscEvent(e,l)},d=()=>{t.style.top=r,t.style.left=a,t.classList.toggle("hidden"),document.addEventListener("keydown",o)},l=()=>{t.classList.toggle("hidden"),document.removeEventListener("keydown",o)};i.addEventListener("click",(()=>d())),i.addEventListener("keydown",(e=>{window.util.isEnterEvent(e,d)})),n.addEventListener("click",(()=>l())),n.addEventListener("keydown",(e=>{window.util.isEnterEvent(e,l)}));const c=()=>{t.classList.add("hidden")},u=e=>{var t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)};e.addEventListener("submit",(function(t){t.preventDefault(),window.backend.save(new FormData(e),c,u)}))})(),(()=>{const e=document.querySelector(".setup"),t=e.querySelector(".upload"),i={x:0,y:0};let n=!1;const s=e=>{e.preventDefault(),t.removeEventListener("click",s)},r=t=>{t.preventDefault(),n=!0;const s={x:i.x-t.clientX,y:i.y-t.clientY};i.x=t.clientX,i.y=t.clientY,(t=>{const i=e.offsetTop-t.y,n=e.offsetLeft-t.x;e.style.top=(i<0?0:i)+"px",e.style.left=(n<400?400:n)+"px"})(s)},a=e=>{e.preventDefault(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",a),n&&t.addEventListener("click",s)};t.addEventListener("mousedown",(e=>{e.preventDefault(),i.x=e.clientX,i.y=e.clientY,n=!1,document.addEventListener("mousemove",r),document.addEventListener("mouseup",a)}))})(),(()=>{const e=["rgb(101, 137, 164)","rgb(241, 43, 107)","rgb(146, 100, 161)","rgb(56, 159, 117)","rgb(215, 210, 55)","rgb(0, 0, 0)"],t=["black","red","blue","yellow","green"],i=["#ee4830","#30a8ee","#5ce6c0","#e848d5","#e6e848"];window.colorize={getCoatColor:()=>e[window.util.getRandomNumberMaxToMin(e.length-1)],getEyesColor:()=>t[window.util.getRandomNumberMaxToMin(t.length-1)],getFireballColor:()=>i[window.util.getRandomNumberMaxToMin(i.length-1)]}})(),(()=>{const e=document.querySelector(".setup-similar-list"),t=document.querySelector("#similar-wizard-template").content;window.render=i=>{e.innerHTML="";const n=document.createDocumentFragment();i.slice(0,4).forEach((e=>i=>e.appendChild((({name:e,colorCoat:i,colorEyes:n})=>{const s=t.cloneNode(!0);return s.querySelector(".setup-similar-label").textContent=e,s.querySelector(".wizard-coat").style.fill=i,s.querySelector(".wizard-eyes").style.fill=n,s})(i)))(n)),e.appendChild(n)}})(),(()=>{const e=document.querySelector(".setup"),t=e.querySelector(".setup-wizard .wizard-coat"),i=document.querySelector('input[name="coat-color"]'),n=e.querySelector(".setup-wizard .wizard-eyes"),s=document.querySelector('input[name="eyes-color"]'),r=e.querySelector(".setup-fireball-wrap"),a=document.querySelector('input[name="fireball-color"]');let o={onCoatChange:()=>{},onEyesChange:()=>{}};t.addEventListener("click",(()=>{const e=window.colorize.getCoatColor();t.style.fill=e,i.value=e,o.onCoatChange(e)})),n.addEventListener("click",(()=>{const e=window.colorize.getEyesColor();n.style.fill=e,s.value=e,o.onEyesChange(e)})),r.addEventListener("click",(()=>{const e=window.colorize.getFireballColor();r.style.backgroundColor=e,a.value=e})),window.wizard={coatChangeHandler:e=>{o.onCoatChange=e},eyesChangeHandler:e=>{o.onEyesChange=e}}})(),window.debounce=e=>{let t=null;return function(...i){t&&window.clearTimeout(t),t=window.setTimeout((()=>e(...i)),500)}},(()=>{const e=document.querySelector(".setup"),t=document.querySelector(".setup-user-name");let i="rgb(101, 137, 164)",n="black",s=[];e.querySelector(".setup-similar").classList.remove("hidden"),t.addEventListener("input",(()=>window.validation.validateUserName()));const r=e=>{let t=0;return e.colorCoat===i&&(t+=2),e.colorEyes===n&&(t+=1),t},a=(e,t)=>{let i=r(t)-r(e);return 0===i&&(i=e.name-t.name),i},o=()=>{window.render(s.slice().sort(a))};window.wizard.coatChangeHandler(window.debounce((e=>{i=e,o()}))),window.wizard.eyesChangeHandler(window.debounce((e=>{n=e,o()}))),window.backend.load((e=>{s=e,o()}),(e=>{window.util.createErrorMessage(e)}))})(),(()=>{const e=document.querySelector(".setup").querySelector(".setup-user-name");window.validation={validateUserName:()=>{const t=e.value.length;t<2?e.setCustomValidity((e=>`Ещё ${2-e} симв.`)(t)):t>25?e.setCustomValidity((e=>`Удалите лишние ${e-25} симв.`)(t)):e.setCustomValidity(""),e.reportValidity()}}})(),(()=>{const e=100,t={X_OFFSET:110,Y_OFFSET:20,COLOR:"rgba(0, 0, 0,0.7)"},i={X_FIRST_LINE:125,Y_FIRST_LINE:40,Y_SECOND_LINE:55,Y_GAP:30,SECOND_LINE_GAP:15,COLOR:"#000",FONT:"16px PT Mono",FIRST_LINE:"Ура вы победили!",SECOND_LINE:"Список результатов: "},n=50+i.Y_GAP,s=(e,t,i,n)=>{e.fillStyle=n,e.fillRect(t,i,420,270)},r=e=>{const[t,i,n,s]=e.length>0?e:[1,2,3,4];return Math.max(t,i,n,s)},a=e=>"Вы"===e?"rgba(255, 0, 0, 1)":o(),o=()=>"hsl(240, "+Math.floor(100*Math.random())+"%, 50%)";window.renderStatistics=(o,d,l)=>{(n=>{s(n,t.X_OFFSET,t.Y_OFFSET,t.COLOR),s(n,e,10,"#fff"),((e,{color:t,font:n,firstLine:s,secondLine:r})=>{e.fillStyle=t,e.font=n,e.fillText(s,i.X_FIRST_LINE,i.Y_FIRST_LINE),e.fillText(r,i.X_FIRST_LINE,i.Y_SECOND_LINE)})(n,{color:i.COLOR,font:i.FONT,firstLine:i.FIRST_LINE,secondLine:i.SECOND_LINE})})(o),((e,t,s)=>{((e,t,i)=>{t.forEach(((t,s)=>{e.fillStyle=i,e.fillText(Math.round(t),150+90*s,n)}))})(e,s,i.COLOR),((e,t,n)=>{const s=r(n);t.forEach(((t,r)=>{e.fillStyle=i.COLOR,e.fillText(t,150+90*r,260),e.fillStyle=a(t),e.fillRect(150+90*r,240,40,150*n[r]*-1/s)}))})(e,t,s)})(o,d,l)}})()})();